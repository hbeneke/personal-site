---
import { getLatestNote } from "@utils/note";
import CloseIcon from "@icons/close.svg";

const latestNote = await getLatestNote();
---

{
  latestNote && (
    <note-announcement>
      <div
        id="note-announcement"
        data-note-slug={latestNote.slug}
        class="fixed bottom-4 right-4 w-80 h-32 bg-gray-100 dark:bg-zinc-800 rounded-lg shadow-lg border border-gray-200 dark:border-zinc-700 p-4 z-50 transition-all duration-300 hover:shadow-xl"
        style="display: none;"
      >
        <button
          id="close-note-announcement"
          class="absolute top-1 right-1 w-5 h-5 bg-gray-200 dark:bg-zinc-700 hover:bg-gray-300 dark:hover:bg-zinc-600 rounded-full flex items-center justify-center transition-colors duration-200"
          aria-label="Close announcement"
        >
          <CloseIcon class="w-2.5 h-2.5 text-yellow-400" />
        </button>

        <!-- Content -->
        <div class="h-full flex flex-col justify-between pr-6">
          <div class="flex-1">
            <div class="flex items-center justify-between gap-2 mb-2">
              <h3 class="font-bold text-sm secondary">
                <a
                  href={`/notes/${latestNote.slug}`}
                  class="hover:underline transition-all duration-200"
                >
                  {latestNote.title}
                </a>
              </h3>
              <time
                datetime={latestNote.publishDate}
                class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0"
              >
                {new Date(latestNote.publishDate).toLocaleString("es-ES", {
                  dateStyle: "short",
                })}
              </time>
            </div>
            
            <div class="text-xs text-gray-600 dark:text-gray-300 leading-tight line-clamp-2">
              <p>{latestNote.description}</p>
            </div>
          </div>

          <div class="mt-2 flex justify-end">
            <a
              id="read-more-link"
              href={`/notes/${latestNote.slug}`}
              class="primary-link text-xs font-medium"
            >
              Read More â†’
            </a>
          </div>
        </div>
      </div>
      
      <script is:inline>
        (function() {
          const announcement = document.getElementById('note-announcement');
          const currentNoteSlug = announcement?.getAttribute('data-note-slug');
          const closedNoteSlug = localStorage.getItem('note-announcement-closed');
          
          if (announcement && currentNoteSlug) {
            if (closedNoteSlug !== currentNoteSlug) {
              announcement.style.display = 'block';
            }
          }
        })();
      </script>
    </note-announcement>
  )
}

<script>
  import("@/scripts/note-announcement");
</script>
