#!/bin/bash

# Skip version bump if this is a post-merge commit or sync commit
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"

# Check if we're in a merge
if [ -f ".git/MERGE_HEAD" ]; then
    echo "✓ Merge in progress. Skipping pre-commit version bump."
    exit 0
fi

# Check if commit message contains version-related keywords
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE" 2>/dev/null || echo "")
    if [[ "$COMMIT_MSG" == *"bump version"* ]] || [[ "$COMMIT_MSG" == *"sync version"* ]] || [[ "$COMMIT_MSG" == *"resolve version conflict"* ]]; then
        echo "✓ Version-related commit detected. Skipping pre-commit version bump."
        exit 0
    fi
fi

if [ ! -f "package.json" ]; then
    echo "package.json not found"
    exit 0
fi

CHANGED_FILES=$(git diff-tree -r --name-only --no-commit-id HEAD)

NON_MD_FILES=$(echo "$CHANGED_FILES" | grep -v '\.md$')

if [ -z "$NON_MD_FILES" ]; then
    echo "✓ Only markdown files modified. Version not updated."
    exit 0
fi

current_version=$(node -p "require('./package.json').version")

if [ -z "$current_version" ]; then
    echo "Could not read version from package.json"
    exit 1
fi

IFS='.' read -r major minor patch <<< "$current_version"

new_patch=$((patch + 1))
new_version="$major.$minor.$new_patch"

if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/\"version\": \"$current_version\"/\"version\": \"$new_version\"/" package.json
else
    sed -i "s/\"version\": \"$current_version\"/\"version\": \"$new_version\"/" package.json
fi

git add package.json

echo "✓ Version updated: $current_version → $new_version (added to commit)"

exit 0
